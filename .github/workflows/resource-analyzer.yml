name: Docker outside of Docker Test

on: [push]

jobs:
  run-container:
    runs-on: ubuntu-latest
    steps:
      - name: Print Docker info
        run: docker info

      - name: Run Docker outside of Docker
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AMP_WORKSPACE_ID: ${{ secrets.AMP_WORKSPACE_ID }}
          CLUSTER_NAME: k3d-test
        run: |
          echo "Starting container..."
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -p 8080:8080 \
            -p 6550:6550 \
            -v ${{ github.workspace }}:/app/manifests \
            -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \
            -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \
            -e AWS_REGION=${AWS_REGION} \
            -e AMP_WORKSPACE_ID=${AMP_WORKSPACE_ID} \
            -e CLUSTER_NAME=${CLUSTER_NAME} \
            public.ecr.aws/y3y8k7w5/k8sresourceautoresizer:latest \
            sh -c "/app/k8s-limits --directory /app/manifests --strategy prophet --history-window 10w --debug"
