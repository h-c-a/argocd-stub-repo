name: k3d in DinD Example

on: [push]

jobs:
  k3d-dind:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Start Docker-in-Docker container
        run: |
          # Launch a docker:dind container in privileged mode
          docker run --privileged --detach \
            --name dind \
            --publish 2375:2375 \
            --env DOCKER_TLS_CERTDIR="" \
            docker:dind \
            dockerd -H 0.0.0.0:2375 --storage-driver=vfs
          
          # Wait a few seconds to ensure the daemon is fully up
          sleep 5

      - name: Test Docker
        env:
          DOCKER_HOST: tcp://localhost:2375
        run: |
          docker version
          docker info

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash
          k3d --version

      - name: Create k3d cluster
        env:
          # Point Docker CLI and k3d at the DinD daemon
          DOCKER_HOST: tcp://localhost:2375
        run: |
          k3d cluster create mycluster
          echo "k3d cluster created!"

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Verify k3d cluster
        env:
          # By default, k3d writes the kubeconfig to ~/.k3d/kubeconfig-<clusterName>.yaml
          KUBECONFIG: ~/.k3d/kubeconfig-mycluster.yaml
        run: |
          kubectl get nodes
          kubectl get pods -A

      - name: Cleanup k3d cluster
        if: always()
        env:
          DOCKER_HOST: tcp://localhost:2375
        run: |
          k3d cluster delete mycluster
          echo "k3d cluster deleted."
