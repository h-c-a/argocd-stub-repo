name: DinD Test

on:
  workflow_dispatch:

jobs:
  test-dind:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run k3d in Docker
        run: |
          docker run --rm \
            --privileged \
            --network=host \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}:/workspace \
            public.ecr.aws/y3y8k7w5/k8sresourceautoresizer:latest \
            sh -c "
              # Start Docker daemon
              dockerd &
              sleep 5
              
              # Create k3d cluster
              k3d cluster create test-cluster \
                --wait \
                --timeout 120s
              
              # Get nodes
              kubectl get nodes
              
              # Clean up
              k3d cluster delete test-cluster
            "
